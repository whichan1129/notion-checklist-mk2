<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¸ë ˆì´ë”© ìº˜ë¦°ë” (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Notion Style Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #E3E2E0; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white text-[#37352F] h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-5xl mx-auto w-full">
        <!-- Header -->
        <header class="flex-none p-4 border-b border-gray-200 flex justify-between items-center bg-white z-10">
            <div class="flex items-center gap-2">
                <button id="back-btn" class="hidden px-3 py-1 text-sm rounded hover:bg-gray-100 flex items-center gap-1 transition-colors" onclick="showCalendar()">
                    <span>â†</span> ë‹¬ë ¥
                </button>
                <h1 id="header-title" class="text-xl font-bold">â˜ï¸ íŠ¸ë ˆì´ë”© ë¡œê·¸</h1>
                <div id="sync-status" class="loader"></div>
            </div>
            <div id="clock-display" class="text-sm text-gray-400 font-mono"></div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow overflow-auto p-4 relative">
            <!-- VIEW 1: CALENDAR -->
            <div id="calendar-view" class="fade-in h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-2 rounded hover:bg-gray-100">â—€</button>
                    <h2 id="current-month-year" class="text-lg font-semibold select-none"></h2>
                    <button onclick="changeMonth(1)" class="p-2 rounded hover:bg-gray-100">â–¶</button>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs text-gray-400 font-medium">
                    <div class="text-red-400">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-400">í† </div>
                </div>
                <div id="calendar-days" class="calendar-grid flex-grow auto-rows-fr"></div>
            </div>

            <!-- VIEW 2: CHECKLIST -->
            <div id="checklist-view" class="hidden fade-in space-y-6 pb-10">
                <div class="bg-gray-50 rounded-lg p-5 border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold" id="selected-date-display">DATE</h2>
                        <span id="day-grade" class="text-xs font-bold px-2 py-1 rounded bg-gray-200 text-gray-600">ì¤€ë¹„ ì¤‘</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                        <div id="daily-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-xs text-right text-gray-500">0% ì™„ë£Œ</p>
                </div>

                <div class="space-y-3" id="task-list">
                    <!-- Tasks will be managed by IDs -->
                    <div class="task-card bg-white border border-gray-200 rounded-md p-4 flex items-start justify-between shadow-sm hover:shadow-md transition-shadow">
                        <div><span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-1 rounded">06:45</span><h3 class="font-medium mt-1">ê¸°ìƒ ë° ìš´ë™</h3></div>
                        <input type="checkbox" class="w-6 h-6 rounded border-gray-300 text-indigo-600 cursor-pointer task-cb" data-task="wakeup">
                    </div>
                    <div class="task-card bg-white border border-gray-200 rounded-md p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-2">
                            <div><span class="text-xs font-bold text-blue-500 bg-blue-50 px-1 rounded">08:00</span><h3 class="font-medium mt-1">ë§ˆì¼“ ë¶„ì„</h3></div>
                            <input type="checkbox" class="w-6 h-6 rounded border-gray-300 text-blue-600 cursor-pointer task-cb" data-task="analysis">
                        </div>
                        <textarea id="note-analysis" class="w-full text-sm bg-gray-50 p-2 rounded border border-gray-200 resize-none h-16" placeholder="ê´€ì  ë©”ëª¨..."></textarea>
                    </div>
                    <div class="task-card bg-white border border-gray-200 rounded-md p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-2">
                            <div><span class="text-xs font-bold text-amber-500 bg-amber-50 px-1 rounded">08:30</span><h3 class="font-medium mt-1">í”„ë¦¬ë§ˆì¼“ íŠ¸ë ˆì´ë“œ</h3></div>
                            <input type="checkbox" class="w-6 h-6 rounded border-gray-300 text-amber-600 cursor-pointer task-cb" data-task="trade">
                        </div>
                        <div class="flex gap-2">
                            <button class="trade-result-btn px-3 py-1 text-xs border rounded hover:bg-gray-50" data-val="win">ìµì ˆ ğŸ’°</button>
                            <button class="trade-result-btn px-3 py-1 text-xs border rounded hover:bg-gray-50" data-val="loss">ì†ì ˆ ğŸ“‰</button>
                            <button class="trade-result-btn px-3 py-1 text-xs border rounded hover:bg-gray-50" data-val="no_trade">ë§¤ë§¤ ì—†ìŒ ğŸš«</button>
                        </div>
                    </div>
                    <div class="task-card bg-white border border-gray-200 rounded-md p-4 flex items-start justify-between shadow-sm hover:shadow-md transition-shadow">
                        <div><span class="text-xs font-bold text-teal-500 bg-teal-50 px-1 rounded">09:00</span><h3 class="font-medium mt-1">ë°© ì²­ì†Œ & ë¦¬ì…‹</h3></div>
                        <input type="checkbox" class="w-6 h-6 rounded border-gray-300 text-teal-600 cursor-pointer task-cb" data-task="cleaning">
                    </div>
                    <div class="task-card bg-white border border-gray-200 rounded-md p-4 flex items-start justify-between shadow-sm hover:shadow-md transition-shadow">
                        <div><span class="text-xs font-bold text-red-500 bg-red-50 px-1 rounded">09:30</span><h3 class="font-medium mt-1">ë³¸ì¥ ì‹œì‘ & CLC</h3></div>
                        <input type="checkbox" class="w-6 h-6 rounded border-gray-300 text-red-600 cursor-pointer task-cb" data-task="clc">
                    </div>
                    <div class="bg-white border border-gray-200 rounded-md p-4 shadow-sm mt-4">
                        <h3 class="font-medium mb-2 text-sm">ğŸ“ ì €ë„</h3>
                        <textarea id="note-journal" class="w-full text-sm bg-gray-50 p-3 rounded border border-gray-200 resize-none h-24 focus:outline-none" placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¡..."></textarea>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ğŸŸ¢ ì‚¬ìš©ìì˜ Firebase ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
        let firebaseConfig;
        let appId = 'default-app'; // ê¸°ë³¸ App ID

        // ìº”ë²„ìŠ¤(ë¯¸ë¦¬ë³´ê¸°) í™˜ê²½ê³¼ ì‹¤ì œ ë°°í¬ í™˜ê²½ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') {
                appId = __app_id;
            }
        } else {
            // ì‹¤ì œ ë°°í¬ ì‹œ ì‚¬ìš©ë˜ëŠ” ì„¤ì • (ì œê³µí•´ì£¼ì‹  ì •ë³´)
            firebaseConfig = {
                apiKey: "AIzaSyAy3Jhb4v_vVq3BPcPK8IboQbzFLkFXcis",
                authDomain: "trading-checklist-ca373.firebaseapp.com",
                projectId: "trading-checklist-ca373",
                storageBucket: "trading-checklist-ca373.firebasestorage.app",
                messagingSenderId: "945835997130",
                appId: "1:945835997130:web:1ba5bcaf658fc52cc74133"
            };
            appId = 'trading-checklist-ca373'; // ê°œì¸ í”„ë¡œì íŠ¸ ID ì‚¬ìš©
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL VARS ---
        let currentDate = new Date();
        let selectedDateKey = null;
        let localData = {}; 
        const tasksList = ['wakeup', 'analysis', 'trade', 'cleaning', 'clc'];
        let saveTimeout;
        let currentUser = null; 

        // --- EXPOSE FUNCTIONS ---
        window.changeMonth = (delta) => {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        };

        window.showCalendar = () => {
            document.getElementById('checklist-view').classList.add('hidden');
            document.getElementById('calendar-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('header-title').innerText = 'â˜ï¸ íŠ¸ë ˆì´ë”© ë¡œê·¸';
            renderCalendar();
        };

        // --- AUTH & STARTUP ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // ìµëª… ë¡œê·¸ì¸: ë³„ë„ ê°€ì… ì—†ì´ ê¸°ê¸°(ë¸Œë¼ìš°ì €)ë³„ ê³ ìœ  IDë¡œ ì ‘ì†
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                alert("ì¸ì¦ ì˜¤ë¥˜: ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Connected as:", user.uid);
                // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë¡œë”©ë°” ìˆ¨ê¹€ ë° ë°ì´í„° ë¡œë“œ
                document.getElementById('sync-status').style.display = 'none';
                loadDataForMonth(currentDate.getFullYear(), currentDate.getMonth());
            }
        });

        initAuth();

        // --- FIRESTORE PATH HELPER ---
        // ğŸ”´ FIX: Path must be compliant with security rules
        function getDocRef(docId) {
            if (!currentUser) return null;
            
            // Path structure: artifacts/{appId}/users/{userId}/logs/{docId}
            // This structure is safe for both Canvas preview and personal projects (if rules allow or test mode is on)
            return doc(db, 'artifacts', appId, 'users', currentUser.uid, 'logs', docId);
        }

        // --- CORE LOGIC ---
        async function loadDataForMonth(year, month) {
            if (!currentUser) return;
            const loader = document.getElementById('sync-status');
            loader.style.display = 'block';
            
            const docId = `${year}-${String(month + 1).padStart(2, '0')}`;
            const docRef = getDocRef(docId);
            
            try {
                const docSnap = await getDoc(docRef);
                localData = docSnap.exists() ? docSnap.data() : {};
            } catch (e) {
                console.error("Load Error:", e);
                // If permission denied or offline, default to empty
                localData = {}; 
            } finally {
                loader.style.display = 'none';
                renderCalendar();
            }
        }

        async function saveData() {
            if (!currentUser || !selectedDateKey) return;
            const loader = document.getElementById('sync-status');
            loader.style.display = 'block';

            const [y, m] = selectedDateKey.split('-');
            const docId = `${y}-${m}`;
            const docRef = getDocRef(docId);

            try {
                await setDoc(docRef, localData);
                console.log("Saved.");
            } catch (e) {
                console.error("Save Error:", e);
                // alert("ì €ì¥ ì‹¤íŒ¨: ê¶Œí•œì´ ì—†ê±°ë‚˜ ì¸í„°ë„· ë¬¸ì œì…ë‹ˆë‹¤.");
            } finally {
                loader.style.display = 'none';
            }
        }

        function triggerSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 1000); 
        }

        // --- RENDER LOGIC (Calendar & UI) ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month-year').innerText = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';

            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

            const todayKey = getTodayKey();

            for (let d = 1; d <= lastDate; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-day border border-gray-100 rounded p-1 flex flex-col items-center justify-start hover:shadow-sm';
                if (dateKey === todayKey) cell.classList.add('bg-blue-50', 'border-blue-200');

                const numSpan = document.createElement('span');
                numSpan.className = 'text-sm font-medium ' + (dateKey === todayKey ? 'text-blue-600' : 'text-gray-700');
                numSpan.innerText = d;
                cell.appendChild(numSpan);

                if (localData[dateKey]) {
                    let completed = 0;
                    tasksList.forEach(t => { if(localData[dateKey][t]) completed++; });
                    if (completed > 0) {
                        const dot = document.createElement('div');
                        dot.className = `w-2 h-2 rounded-full mt-1 ${completed === tasksList.length ? 'bg-green-500' : 'bg-blue-400'}`;
                        cell.appendChild(dot);
                    }
                }
                cell.onclick = () => openChecklist(dateKey);
                grid.appendChild(cell);
            }
        }

        function getTodayKey() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        window.openChecklist = (dateKey) => {
            selectedDateKey = dateKey;
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('checklist-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            
            const [y, m, d] = dateKey.split('-');
            document.getElementById('selected-date-display').innerText = `${m}ì›” ${d}ì¼`;
            document.getElementById('header-title').innerText = `${y}.${m}.${d}`;

            if (!localData[dateKey]) {
                localData[dateKey] = { trade_result: null, notes_analysis: '', notes_journal: '' };
                tasksList.forEach(t => localData[dateKey][t] = false);
            }

            const data = localData[dateKey];
            document.querySelectorAll('.task-cb').forEach(cb => {
                cb.checked = data[cb.getAttribute('data-task')] || false;
            });
            document.getElementById('note-analysis').value = data.notes_analysis || '';
            document.getElementById('note-journal').value = data.notes_journal || '';
            updateTradeButtons(data.trade_result);
            updateDailyProgress();
        };

        function updateDailyProgress() {
            if (!selectedDateKey) return;
            const data = localData[selectedDateKey];
            let completed = 0;
            tasksList.forEach(t => { if(data[t]) completed++; });

            const pct = Math.round((completed / tasksList.length) * 100);
            const bar = document.getElementById('daily-progress-bar');
            bar.style.width = `${pct}%`;
            bar.className = `h-2.5 rounded-full transition-all duration-500 ${pct === 100 ? 'bg-green-500' : 'bg-blue-600'}`;
            document.getElementById('progress-text').innerText = `${pct}% ì™„ë£Œ`;
            
            const badge = document.getElementById('day-grade');
            badge.innerText = pct === 100 ? "PERFECT" : (pct > 0 ? "ì§„í–‰ ì¤‘" : "ì‹œì‘ ì „");
            badge.className = `text-xs font-bold px-2 py-1 rounded ${pct === 100 ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`;
        }

        function updateTradeButtons(val) {
            document.querySelectorAll('.trade-result-btn').forEach(btn => {
                const bVal = btn.getAttribute('data-val');
                let base = 'trade-result-btn px-3 py-1 text-xs border rounded transition-colors text-gray-500 hover:bg-gray-50';
                if (val === bVal) {
                    if(val==='win') base += ' bg-green-100 text-green-700 border-green-500 font-bold';
                    if(val==='loss') base += ' bg-red-100 text-red-700 border-red-500 font-bold';
                    if(val==='no_trade') base += ' bg-gray-600 text-white border-gray-600 font-bold';
                }
                btn.className = base;
            });
        }

        // --- LISTENERS ---
        document.querySelectorAll('.task-cb').forEach(cb => {
            cb.addEventListener('change', (e) => {
                localData[selectedDateKey][e.target.getAttribute('data-task')] = e.target.checked;
                updateDailyProgress();
                triggerSave();
            });
        });
        document.getElementById('note-analysis').addEventListener('input', (e) => {
            localData[selectedDateKey].notes_analysis = e.target.value;
            triggerSave();
        });
        document.getElementById('note-journal').addEventListener('input', (e) => {
            localData[selectedDateKey].notes_journal = e.target.value;
            triggerSave();
        });
        document.querySelectorAll('.trade-result-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const val = e.target.getAttribute('data-val');
                const current = localData[selectedDateKey].trade_result;
                const newVal = current === val ? null : val;
                localData[selectedDateKey].trade_result = newVal;
                if(newVal) {
                    localData[selectedDateKey]['trade'] = true;
                    document.querySelector('.task-cb[data-task="trade"]').checked = true;
                }
                updateTradeButtons(newVal);
                updateDailyProgress();
                triggerSave();
            });
        });

        // Clock
        setInterval(() => {
            document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('ko-KR', {hour12:false, hour:'2-digit', minute:'2-digit'});
        }, 1000);
    </script>
</body>
</html>
